#!/usr/bin/env python3

import socket
import umsgpack
import re

LPORT = 9999
LHOST = "127.0.0.1"
MAXCONNECTIONS = 1
BYTES = 4096
REGEXP = '[0-9]{2}\.[0-9]{2}\.[0-9]{4}'

sock = socket.socket()
sock.bind((LHOST, LPORT))
sock.listen(MAXCONNECTIONS)

conn, addr = sock.accept()

while True:
    try:
        data = conn.recv(BYTES)
        udata = umsgpack.loads(data)

        if re.match(REGEXP, udata['test_date']):
            conn.send(umsgpack.dumps({"result": "ok"}))
            continue
        else:
            conn.send(umsgpack.dumps({"result": "error"}))
    except:
        sock.close()
        break
